<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.team3webnovel.mappers.VideoMapper">
	<!-- creation 테이블에 데이터 삽입 (CREATION_ID는 시퀀스에 의해 자동 생성됨) -->
    <insert id="insertCreation" parameterType="map">
        INSERT INTO creation (user_id, art_form)
        VALUES (#{userId}, #{artForm})
    </insert>

    <!-- 마지막으로 삽입된 creation_id 가져오기 -->
    <select id="getLastCreationId" resultType="int">
        SELECT MAX(creation_id) FROM creation
    </select>

    <!-- video_data 테이블에 비디오 데이터 삽입 -->
    <insert id="insertVideoData" parameterType="map">
        INSERT INTO video_generation_data (
            creation_id, video_url, modelcheck, sampler,
            prompt, n_prompt, steps, cfg, seed, 
            width, height, video_frames, motion_bucket_id, fps, filename, title
        )
        VALUES (
            #{creationId}, #{videoUrl}, #{modelCheck}, #{sampler}, 
            #{prompt}, #{nPrompt}, #{steps}, #{cfg}, #{seed}, 
            #{width}, #{height}, #{videoFrames}, #{motionBucketId}, #{fps}, #{fileName}, #{fileName}
        )
    </insert>
    
    <!-- 특정 사용자 ID로 비디오 데이터 조회 -->
    <select id="getVideoDataByUserId" parameterType="com.team3webnovel.vo.CreationVo" resultType="com.team3webnovel.vo.VideoVo">
        SELECT 
            vgd.creation_id AS creationId, vgd.video_url AS videoUrl,
            vgd.created_at AS createdAt, sampler, prompt, 
            n_prompt AS nPrompt, steps, cfg, seed, 
            width, height, modelcheck AS modelCheck, video_frames AS videoFrames,
            motion_bucket_id AS motionBucketId, fps, filename AS title
        FROM video_generation_data vgd
        JOIN creation c ON vgd.creation_id = c.creation_id
        WHERE c.user_id = #{userId} AND c.art_form = 2
    </select>
    
    <!-- 비디오에 대한 resultMap -->
    <resultMap id="videoResultMap" type="com.team3webnovel.vo.VideoVo">
        <result property="creationId" column="CREATION_ID"/>
        <result property="title" column="TITLE"/>
        <result property="videoUrl" column="VIDEO_URL"/>
        <result property="createdAt" column="CREATED_AT" javaType="java.sql.Timestamp" jdbcType="TIMESTAMP"/>
        <result property="modelCheck" column="MODELCHECK"/>
        <result property="sampler" column="SAMPLER"/>
        <result property="prompt" column="PROMPT"/>
        <result property="nPrompt" column="N_PROMPT"/>
        <result property="steps" column="STEPS"/>
        <result property="cfg" column="CFG"/>
        <result property="seed" column="SEED"/>
        <result property="width" column="WIDTH"/>
        <result property="height" column="HEIGHT"/>
        <result property="videoFrames" column="VIDEO_FRAMES"/>
        <result property="motionBucketId" column="MOTION_BUCKET_ID"/>
        <result property="fps" column="FPS"/>
    </resultMap>

    <!-- creation_id로 비디오 정보 조회 -->
    <select id="getAllInformation" parameterType="int" resultMap="videoResultMap">
        SELECT 
            creation_id, video_url, created_at, modelcheck, 
            sampler, prompt, n_prompt, steps, cfg, 
            seed, width, height, video_frames, motion_bucket_id, 
            fps, filename AS title
        FROM video_generation_data
        WHERE creation_id = #{creationId}
    </select>

</mapper>
